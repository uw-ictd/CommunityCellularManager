---

- name: Set up a network in a box on a local virtual machine
  hosts: nitb
  become: yes

  tasks:

    - name: Add Osmocom apt GPG key
      apt_key:
          url: https://download.opensuse.org/repositories/network:/osmocom:/nightly/Debian_9.0/Release.key
          state: present

    # TODO(issues/6) Convert to the latest branch when stable and ready for deployment.
    - name: Add Osmocom Debian 9 nightly repo
      apt_repository:
          repo: 'deb http://download.opensuse.org/repositories/network:/osmocom:/nightly/Debian_9.0 ./'
          update_cache: no
          mode: 664
      register: osmocom_repo

    - name: Run the equivalent of "apt-get update" as a separate step
      when: osmocom_repo.changed
      apt:
          update_cache: yes

    - name: Install utilities for terminal interaction
      apt: pkg={{ item }} state=present update_cache=no
      with_items:
          - fish
          - tmux
          - python3-dev
          - emacs-nox
          - usbutils

    - name: Install uhd drivers for USRP
      apt: pkg={{ item }} state=present update_cache=no
      with_items:
          - libuhd-dev
          - libuhd003
          - uhd-host

    # TODO(matt9j) Figure out when the images actually need to be
    # re-downloaded. Flashing the radio firmware may need to take
    # place on the host to even be detected by virtualbox, but in an
    # actual deployment will need to take place on the nuc.

    #- name: Download the latest USRP images
    #  shell: uhd_images_downloader

    - name: Install Osmocom core network components
      apt: pkg={{ item }} state=present update_cache=no
      with_items:
          - osmo-hlr
          - osmo-msc
          - osmo-mgw
          - osmo-stp
          - osmo-bsc

    - name: Install Osmocom USRP BTS components
      apt: pkg={{ item }} state=present update_cache=no
      with_items:
          - osmo-bts-trx
          - osmo-trx

    - name: Create a directory for the HLR
      file:
          path: /var/lib/osmocom
          state: directory

    - name: Copy osmocom configuration files
      copy:
        src: "{{ item }}"
        dest: /etc/osmocom/
        force: yes
      with_fileglob:
        - ../config/nitb/*
        
